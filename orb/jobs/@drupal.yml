analyze:
  description: "Drupal code analyze job."
  executor: <<parameters.executor>>
  parameters:
    executor:
      description: "The name of custom executor to use."
      type: executor
      default: sonar
    sources:
      description: "Codebase scan paths."
      type: string
      default: "web/modules,web/themes"
  steps:
    - checkout
    - run: >-
        sonar-scanner -Dsonar.host.url="${SONAR_HOST}"
        -Dsonar.login="${SONAR_TOKEN}"
        -Dsonar.projectKey="${CIRCLE_PROJECT_REPONAME,,}"
        -Dsonar.sources='<<parameters.sources>>'

drupal-validate:
  description: "Drupal code validation job."
  executor: <<parameters.executor>>
  parameters:
    executor:
      description: "The name of custom executor to use."
      type: executor
      default: silta
    drupal-root:
      description: "Relative path to drupal root"
      type: string
      default: "."
    web-root:
      description: "Relative path to drupal webroot."
      type: string
      default: "web"
    pre-validation:
      description: "Preparational build steps run after code checkout."
      type: steps
      default: []
    post-validation:
      description: "Extra steps to be executed after drupal code validation."
      type: steps
      default: []
  working_directory: ~/project/<<parameters.drupal-root>>
  steps:
    - checkout:
        path: ~/project
    - steps: <<parameters.pre-validation>>
    - drupal-composer-install:
        install-dev-dependencies: true
    - phpcs
    - grumphp
    - run:
        name: Silta basic checks
        command: |
          files=(
            silta/silta.yml
            silta/silta-prod.yml
            silta/nginx.Dockerfile
            silta/php.Dockerfile
            silta/shell.Dockerfile
            .dockerignore
            <<parameters.web-root>>/.dockerignore
          )

          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file is present"
            else
              echo "❌ $file is missing from the repository."
              exit 1
            fi
          done

          if grep "drush.*8" composer.json; then
            echo "❌ Silta is not compatible with drush 8."
          fi

    - steps: <<parameters.post-validation>>

drupal-build-deploy:
  description: "Build and deploy drupal chart release."
  executor: <<parameters.executor>>
  parameters:
    executor:
      description: "The name of custom executor to use."
      type: executor
      default: silta
    drupal-root:
      description: "Relative path to drupal root"
      type: string
      default: "."
    codebase-build:
      description: "Preparational build steps run after code checkout."
      type: steps
      default: []
    pre-release:
      description: "Steps to be executed before the Helm release is created."
      type: steps
      default: []
    chart_name:
      description: "Helm chart name."
      type: string
      default: drupal
    chart_version:
      description: "Deploy specific drupal helm chart version."
      type: string
      default: ""
    chart_repository:
      description: "Helm chart repository."
      type: string
      default: https://storage.googleapis.com/charts.wdr.io
    decrypt_files:
      description: "Encrypted value files. Can have multiple, comma separated values."
      type: string
      default: ""
    silta_config:
      description: "Chart values override file. Can have multiple, comma separated values."
      type: string
      default: "silta/silta.yml"
    skip-deployment:
      description: "Skip release deployment."
      type: boolean
      default: false
    cluster_domain:
      description: "Cluster domain value for helm chart. Will be used for default ingress hostnames."
      type: env_var_name
      default: CLUSTER_DOMAIN
    release-suffix:
      description: "Release name suffix."
      type: string
      default: ''
    deployment_timeout:
      description: "Helm release deployment timeout."
      type: string
      default: "15m"
    nginx_build_context:
      description: "Path to be used as build context for Nginx image build."
      type: string
      default: "web"
  working_directory: ~/project/<<parameters.drupal-root>>
  steps:
    - checkout:
        path: ~/project
    - steps: <<parameters.codebase-build>>
    - unless:
        condition: <<parameters.skip-deployment>>
        steps:
          - when:
              condition: <<parameters.decrypt_files>>
              steps:
                - decrypt-files:
                    files: <<parameters.decrypt_files>>
          - silta-setup:
              release-suffix: '<<parameters.release-suffix>>'
          - drupal-docker-build:
              nginx_build_context: <<parameters.nginx_build_context>>
          - steps: <<parameters.pre-release>>
          - drupal-helm-deploy:
              chart_name: <<parameters.chart_name>>
              chart_version: <<parameters.chart_version>>
              chart_repository: <<parameters.chart_repository>>
              silta_config: <<parameters.silta_config>>
              cluster_domain: <<parameters.cluster_domain>>
              deployment_timeout: <<parameters.deployment_timeout>>
