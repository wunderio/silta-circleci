simple-build-deploy:
  description: "Build and deploy simple chart release."
  executor: <<parameters.executor>>
  resource_class: <<parameters.resource_class>>
  parameters:
    executor:
      description: "The name of custom executor to use."
      type: executor
      default: silta
    codebase-build:
      description: "Preparational build steps run after code checkout."
      type: steps
      default: []
    chart_name:
      description: "Helm chart name."
      type: string
      default: simple
    chart_repository:
      description: "Helm chart repository."
      type: string
      default: https://storage.googleapis.com/charts.wdr.io
    silta_config:
      description: "Chart values override file. Can have multiple, comma separated values."
      type: string
      default: "silta/silta.yml"
    skip-deployment:
      description: "Skip release deployment."
      type: boolean
      default: false
    cluster_domain:
      description: "Cluster domain value for helm chart. Will be used for default ingress hostnames."
      type: env_var_name
      default: CLUSTER_DOMAIN
    codebase_root:
      description: "Relative path for codebase root."
      type: string
      default: .
    build_folder:
      description: "Relative path for Dockerfile build context."
      type: string
      default: public
    pre-release:
      description: "Steps to be executed before the Helm release is created."
      type: steps
      default: []
    release-suffix:
      description: "Release name suffix."
      type: string
      default: ''
    resource_class:
      description: "Amount of CPU and RAM allocated to each CircleCI executor container in a build job. See [CircleCI reference](https://circleci.com/docs/2.0/configuration-reference/#resourceclass)."
      type: string
      # Medium is the default when not specified.
      default: medium
  working_directory: ~/project/<<parameters.codebase_root>>
  steps:
    - checkout:
        path: ~/project

    - steps: <<parameters.codebase-build>>

    - silta-setup:
        release-suffix: '<<parameters.release-suffix>>'

    - build-docker-image:
        dockerfile: 'silta/nginx.Dockerfile'
        path: <<parameters.build_folder>>
        identifier: 'nginx'
        docker-hash-prefix: v7

    - steps: <<parameters.pre-release>>

    - unless:
        condition: <<parameters.skip-deployment>>
        steps:
          - helm-cleanup

          - run:
              name: Deploy helm release
              command: |
                # Add internal VPN if defined in environment
                extra_noauthips=""
                if [[ ! -z "$VPN_IP" ]] ; then
                  extra_noauthips="--set nginx.noauthips.vpn=${VPN_IP}/32"
                fi

                # Pass VPC native setting if defined in environment
                extra_vpcnative=""
                if [[ ! -z "$VPC_NATIVE" ]] ; then
                  extra_vpcnative="--set cluster.vpcNative=${VPC_NATIVE}"
                fi

                # Add cluster type if defined in environment
                extra_clustertype=""
                if [[ ! -z "$CLUSTER_TYPE" ]] ; then
                  extra_clustertype="--set cluster.type=${CLUSTER_TYPE}"
                fi

                helm upgrade --install "$RELEASE_NAME" '<<parameters.chart_name>>' \
                  --repo '<<parameters.chart_repository>>' \
                  --cleanup-on-fail \
                  --set environmentName="$SILTA_ENVIRONMENT_NAME" \
                  --set silta-release.branchName="$CIRCLE_BRANCH" \
                  $extra_noauthips \
                  $extra_vpcnative \
                  $extra_clustertype \
                  --set clusterDomain=${<<parameters.cluster_domain>>} \
                  --set nginx.image=$DOCKER_REPO_HOST/$DOCKER_REPO_PROJ/$NAMESPACE-nginx:$nginx_HASH \
                  --namespace="$NAMESPACE" \
                  --values '<<parameters.silta_config>>' \
                  --wait

          - helm-release-information
